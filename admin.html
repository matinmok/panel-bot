<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>پنل مدیریت طوفان سرور - ادمین</title>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    
    <!-- Vazir Font -->
    <link href="https://v1.fontapi.ir/css/Vazir" rel="stylesheet">
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
    
    <style>
        /* Force Font Awesome Icons to Load */
        .fas, .far, .fab, .fa {
            font-family: "Font Awesome 6 Free", "Font Awesome 6 Pro", "Font Awesome 6 Brands", "FontAwesome" !important;
            font-weight: 900 !important;
            font-style: normal !important;
            font-variant: normal !important;
            text-rendering: auto !important;
            line-height: 1 !important;
            -webkit-font-smoothing: antialiased !important;
            -moz-osx-font-smoothing: grayscale !important;
            display: inline-block !important;
            text-decoration: none !important;
        }
        
        * {
            font-family: 'Vazir', 'Tahoma', 'Arial', sans-serif !important;
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        :root {
            --primary-color: #1e3a8a;
            --primary-light: #3b82f6;
            --primary-dark: #1e40af;
            --secondary-color: #064e3b;
            --accent-color: #F59E0B;
            --success-color: #10B981;
            --danger-color: #EF4444;
            --warning-color: #F59E0B;
            --info-color: #1e40af;
            
            /* Light theme */
            --bg-primary: #FFFFFF;
            --bg-secondary: #F8FAFC;
            --bg-tertiary: #F1F5F9;
            --card-bg: #FFFFFF;
            --text-primary: #1E293B;
            --text-secondary: #64748B;
            --text-muted: #94A3B8;
            --border-color: #E2E8F0;
            --border-light: #F1F5F9;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
        }

        [data-theme="dark"] {
            --bg-primary: #0F172A;
            --bg-secondary: #1E293B;
            --bg-tertiary: #334155;
            --card-bg: #1E293B;
            --text-primary: #F8FAFC;
            --text-secondary: #CBD5E1;
            --text-muted: #64748B;
            --border-color: #334155;
            --border-light: #475569;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.3);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.3), 0 2px 4px -2px rgb(0 0 0 / 0.3);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.3), 0 4px 6px -4px rgb(0 0 0 / 0.3);
            --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.3), 0 8px 10px -6px rgb(0 0 0 / 0.3);
        }

        body {
            margin: 0;
            background: var(--bg-primary);
            color: var(--text-primary);
            overflow-x: hidden;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        
        .loading-spinner {
            border: 2px solid transparent;
            border-top: 2px solid var(--primary-color);
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-left: 8px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Connection Status Indicator */
        .connection-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 2100;
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 8px 12px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 6px;
            box-shadow: var(--shadow-md);
            transition: all 0.3s ease;
        }

        .connection-indicator.connected { border-color: var(--success-color); color: var(--success-color); }
        .connection-indicator.disconnected { border-color: var(--danger-color); color: var(--danger-color); }
        .connection-indicator.connecting { border-color: var(--warning-color); color: var(--warning-color); }

        /* Theme Toggle */
        .theme-toggle {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 2000;
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 50px;
            padding: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: var(--shadow-md);
            display: flex;
            align-items: center;
            gap: 8px;
            min-width: 60px;
            justify-content: center;
        }
        .theme-toggle:hover { transform: translateY(-2px); box-shadow: var(--shadow-lg); }
        .theme-toggle i { font-size: 18px; color: var(--text-primary); transition: all 0.3s ease; }
        .theme-toggle .fa-sun { color: #f59e0b; }
        .theme-toggle .fa-moon { color: #1e3a8a; }
        
        /* Server URL Setting */
        .server-setting {
            position: fixed;
            bottom: 20px;
            left: 20px;
            z-index: 2000;
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: var(--shadow-md);
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            color: var(--text-secondary);
            min-width: 120px;
            justify-content: center;
        }
        .server-setting:hover { transform: translateY(-2px); box-shadow: var(--shadow-lg); color: var(--primary-color); }
        .server-setting i { font-size: 14px; }
        
        /* Login Styles */
        .login-container { min-height: 100vh; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%); padding: 16px; }
        .login-card { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(20px); padding: 32px; border-radius: 24px; box-shadow: var(--shadow-xl); width: 100%; max-width: 400px; position: relative; border: 1px solid rgba(255, 255, 255, 0.2); }
        [data-theme="dark"] .login-card { background: rgba(30, 41, 59, 0.95); border: 1px solid rgba(255, 255, 255, 0.1); }
        .login-header { text-align: center; margin-bottom: 32px; }
        .login-logo { width: 64px; height: 64px; background: linear-gradient(135deg, var(--primary-color), var(--primary-light)); border-radius: 16px; margin: 0 auto 20px; display: flex; align-items: center; justify-content: center; font-size: 28px; color: #fff; box-shadow: var(--shadow-lg); }
        .login-title { color: var(--text-primary); font-size: 24px; font-weight: 700; margin-bottom: 8px; }
        .login-subtitle { color: var(--text-secondary); font-size: 14px; font-weight: 500; }
        .login-footer { text-align: center; margin-top: 32px; padding-top: 20px; border-top: 1px solid var(--border-light); }
        .login-copyright { font-size: 11px; color: var(--text-muted); line-height: 1.5; }
        .form-group { margin-bottom: 20px; }
        .form-label { display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-primary); font-size: 14px; }
        .form-input { width: 100%; padding: 14px 16px; border: 2px solid var(--border-color); border-radius: 12px; font-size: 16px; background: var(--card-bg); color: var(--text-primary); transition: all 0.3s ease; outline: none; }
        .form-input:focus { border-color: var(--primary-color); box-shadow: 0 0 0 4px rgba(30, 58, 138, 0.1); transform: translateY(-1px); }
        .form-input::placeholder { color: var(--text-muted); }
        .login-btn { width: 100%; background: linear-gradient(135deg, var(--primary-color), var(--primary-light)); color: #fff; border: none; padding: 16px; border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .login-btn:hover:not(:disabled) { transform: translateY(-2px); box-shadow: var(--shadow-lg); }
        .login-btn:disabled { opacity: 0.7; cursor: not-allowed; transform: none; }
        .error-message, .success-message { padding: 12px 16px; border-radius: 8px; margin-bottom: 16px; font-size: 14px; text-align: center; font-weight: 500; }
        .error-message { background: rgba(239, 68, 68, 0.1); color: var(--danger-color); border: 1px solid rgba(239, 68, 68, 0.2); }
        .success-message { background: rgba(16, 185, 129, 0.1); color: var(--success-color); border: 1px solid rgba(16, 185, 129, 0.2); }
        
        /* Panel Styles */
        .panel-container { display: flex; min-height: 100vh; background: var(--bg-primary); position: relative; }
        .panel-nav { width: 280px; background: var(--card-bg); border-left: 1px solid var(--border-color); display: flex; flex-direction: column; padding: 24px; position: fixed; height: 100vh; overflow-y: auto; z-index: 1500; box-shadow: var(--shadow-lg); right: 0; top: 0; transition: all 0.3s ease; }
        .nav-header { text-align: center; margin-bottom: 32px; padding-bottom: 24px; border-bottom: 1px solid var(--border-light); }
        .nav-logo { width: 56px; height: 56px; background: linear-gradient(135deg, var(--primary-color), var(--primary-light)); border-radius: 14px; margin: 0 auto 16px; display: flex; align-items: center; justify-content: center; font-size: 24px; color: #fff; box-shadow: var(--shadow-md); }
        .nav-title { font-size: 18px; font-weight: 700; margin-bottom: 4px; color: var(--text-primary); }
        .nav-subtitle { font-size: 13px; color: var(--text-secondary); font-weight: 500; }
        .nav-menu { flex: 1; }
        .nav-item { background: none; color: var(--text-secondary); border: none; padding: 14px 16px; text-align: right; font-size: 14px; cursor: pointer; border-radius: 12px; margin: 3px 0; width: 100%; display: flex; align-items: center; justify-content: space-between; transition: all 0.3s ease; font-weight: 500; direction: rtl; }
        .nav-item i { margin-right: 12px; width: 18px; text-align: center; font-size: 16px; flex-shrink: 0; }
        .nav-item:hover { background: var(--bg-secondary); color: var(--text-primary); transform: translateX(2px); }
        .nav-item.active { background: linear-gradient(135deg, var(--primary-color), var(--primary-light)); color: #fff; box-shadow: var(--shadow-md); }
        .nav-footer { border-top: 1px solid var(--border-light); padding-top: 24px; text-align: center; }
        .logout-btn { background: var(--bg-secondary); color: var(--text-secondary); border: 1px solid var(--border-color); padding: 10px 16px; border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: 500; transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; gap: 6px; width: 100%; }
        .logout-btn:hover { background: var(--danger-color); color: #fff; border-color: var(--danger-color); }
        .panel-content { flex: 1; padding: 24px; background: var(--bg-primary); margin-right: 280px; min-height: 100vh; position: relative; z-index: 1; }
        .content-header { color: var(--text-primary); font-size: 32px; margin-bottom: 32px; text-align: center; font-weight: 800; background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        .content-section { display: none; background: var(--card-bg); padding: 24px; border-radius: 16px; box-shadow: var(--shadow-md); margin-bottom: 24px; border: 1px solid var(--border-color); }
        .content-section.active { display: block; }
        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; flex-wrap: wrap; gap: 16px; }
        .section-title { color: var(--text-primary); font-size: 22px; margin: 0; font-weight: 700; display: flex; align-items: center; gap: 12px; }
        .section-title::before { content: ''; width: 4px; height: 24px; background: linear-gradient(135deg, var(--primary-color), var(--primary-light)); border-radius: 2px; }
        .refresh-btn { background: var(--primary-color); color: #fff; border: none; padding: 10px 16px; border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: 600; transition: all 0.3s ease; display: flex; align-items: center; gap: 8px; border: 1px solid transparent; }
        .refresh-btn:hover:not(:disabled) { transform: translateY(-2px); box-shadow: var(--shadow-md); background: var(--primary-light); }
        .refresh-btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; box-shadow: none; }
        
        /* Stats Cards */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px; margin-bottom: 32px; }
        .stats-card { background: var(--card-bg); padding: 24px; border-radius: 16px; box-shadow: var(--shadow-md); text-align: center; border: 1px solid var(--border-color); transition: all 0.3s ease; position: relative; overflow: hidden; }
        .stats-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 4px; background: linear-gradient(135deg, var(--primary-color), var(--primary-light)); }
        .stats-card:hover { transform: translateY(-4px); box-shadow: var(--shadow-lg); }
        .stats-icon { width: 48px; height: 48px; background: linear-gradient(135deg, var(--primary-color), var(--primary-light)); border-radius: 12px; margin: 0 auto 16px; display: flex; align-items: center; justify-content: center; font-size: 20px; color: #fff; box-shadow: var(--shadow-md); }
        .stats-number { font-size: 28px; font-weight: 800; color: var(--text-primary); margin-bottom: 8px; }
        .stats-label { color: var(--text-secondary); font-size: 13px; font-weight: 500; }
        
        /* System Cards */
        .system-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-bottom: 32px; }
        .system-card { background: var(--card-bg); padding: 24px; border-radius: 16px; box-shadow: var(--shadow-md); border: 1px solid var(--border-color); transition: all 0.3s ease; position: relative; overflow: hidden; }
        .system-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 4px; background: linear-gradient(135deg, var(--secondary-color), var(--accent-color)); }
        .system-card:hover { transform: translateY(-4px); box-shadow: var(--shadow-lg); }
        .system-icon { width: 48px; height: 48px; background: linear-gradient(135deg, var(--secondary-color), var(--accent-color)); border-radius: 12px; margin: 0 auto 16px; display: flex; align-items: center; justify-content: center; font-size: 20px; color: #fff; box-shadow: var(--shadow-md); }
        .system-title { font-size: 16px; font-weight: 600; color: var(--text-primary); margin-bottom: 12px; text-align: center; }
        .system-value { font-size: 24px; font-weight: 800; color: var(--text-primary); margin-bottom: 8px; text-align: center; }
        .system-details { color: var(--text-secondary); font-size: 12px; text-align: center; }
        
        /* Table Styles */
        .data-table { width: 100%; border-collapse: separate; border-spacing: 0; margin-top: 20px; background: var(--card-bg); border-radius: 12px; overflow: hidden; box-shadow: var(--shadow-md); border: 1px solid var(--border-color); }
        .data-table th, .data-table td { padding: 16px 12px; text-align: right; font-size: 14px; border-bottom: 1px solid var(--border-light); }
        .data-table th { background: var(--bg-secondary); color: var(--text-primary); font-weight: 600; font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px; }
        .data-table tbody tr { transition: all 0.2s ease; }
        .data-table tbody tr:hover { background: var(--bg-secondary); }
        .data-table tbody tr:last-child td { border-bottom: none; }
        
        /* Form Styles */
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-bottom: 24px; }
        .form-button { background: var(--primary-color); color: #fff; border: none; padding: 10px 16px; border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: 600; transition: all 0.3s ease; margin: 2px; display: inline-flex; align-items: center; justify-content: center; gap: 6px; border: 1px solid transparent; }
        .form-button:hover:not(:disabled) { transform: translateY(-2px); box-shadow: var(--shadow-md); }
        .form-button:disabled { opacity: 0.6; cursor: not-allowed; transform: none; box-shadow: none; }
        .form-button.danger { background: var(--danger-color); }
        .form-button.success { background: var(--success-color); }
        .form-button.info { background: var(--info-color); }
        .form-button.warning { background: var(--warning-color); }
        .form-button.secondary { background: var(--bg-secondary); color: var(--text-primary); border-color: var(--border-color); }
        
        /* Status Badges */
        .status-badge { padding: 6px 12px; border-radius: 20px; font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
        .status-active { background: rgba(16, 185, 129, 0.1); color: var(--success-color); border: 1px solid rgba(16, 185, 129, 0.2); }
        .status-disabled { background: rgba(107, 114, 128, 0.1); color: #6B7280; border: 1px solid rgba(107, 114, 128, 0.2); }
        .status-expired { background: rgba(239, 68, 68, 0.1); color: var(--danger-color); border: 1px solid rgba(239, 68, 68, 0.2); }
        .status-limited { background: rgba(245, 158, 11, 0.1); color: var(--warning-color); border: 1px solid rgba(245, 158, 11, 0.2); }
        
        /* Progress Bar */
        .progress-bar { background: var(--border-light); border-radius: 10px; height: 8px; overflow: hidden; margin: 6px 0; }
        .progress-fill { background: linear-gradient(135deg, var(--primary-color), var(--primary-light)); height: 100%; border-radius: 10px; transition: width 0.5s ease; }
        
        /* Search Box */
        .search-box { width: 100%; padding: 12px 16px; border: 2px solid var(--border-color); border-radius: 12px; font-size: 14px; margin-bottom: 20px; background: var(--card-bg); color: var(--text-primary); transition: all 0.3s ease; }
        .search-box:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 4px rgba(30, 58, 138, 0.1); }
        .search-box::placeholder { color: var(--text-muted); }
        
        /* Modal Styles */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); backdrop-filter: blur(4px); display: flex; align-items: center; justify-content: center; z-index: 2000; padding: 20px; }
        .modal-content { background: var(--card-bg); padding: 28px; border-radius: 16px; max-width: 700px; width: 100%; max-height: 90vh; overflow-y: auto; box-shadow: var(--shadow-xl); border: 1px solid var(--border-color); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; padding-bottom: 16px; border-bottom: 1px solid var(--border-light); }
        .modal-title { color: var(--text-primary); font-size: 20px; font-weight: 700; }
        .modal-close { background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 50%; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; font-size: 14px; cursor: pointer; color: var(--text-secondary); transition: all 0.3s ease; }
        .modal-close:hover { background: var(--danger-color); color: #fff; border-color: var(--danger-color); }
        
        /* Representative Monitor Styles */
        .monitor-card { background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 12px; padding: 20px; margin-bottom: 16px; transition: all 0.3s ease; position: relative; overflow: hidden; }
        .monitor-card::before { content: ''; position: absolute; top: 0; right: 0; width: 4px; height: 100%; background: linear-gradient(135deg, var(--success-color), var(--secondary-color)); }
        .monitor-card.error::before { background: linear-gradient(135deg, var(--danger-color), var(--warning-color)); }
        .monitor-card:hover { box-shadow: var(--shadow-md); transform: translateY(-2px); }
        .monitor-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; flex-wrap: wrap; gap: 12px; }
        .monitor-username { font-size: 18px; font-weight: 600; color: var(--text-primary); margin: 0; }
        .monitor-status { display: flex; align-items: center; gap: 8px; font-size: 12px; color: var(--text-secondary); }
        .monitor-status .fa-check-circle { color: var(--success-color); }
        .monitor-status .fa-exclamation-triangle { color: var(--danger-color); }
        .monitor-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 16px; margin-top: 16px; }
        .monitor-stat { text-align: center; padding: 12px; background: var(--bg-secondary); border-radius: 8px; border: 1px solid var(--border-light); }
        .monitor-stat-value { font-size: 20px; font-weight: 700; color: var(--text-primary); margin-bottom: 4px; }
        .monitor-stat-label { font-size: 11px; color: var(--text-secondary); font-weight: 500; }
        
        /* Mobile Header */
        .mobile-header { display: none; position: fixed; top: 0; left: 0; right: 0; width: 100%; background: var(--card-bg); border-bottom: 1px solid var(--border-color); color: var(--text-primary); padding: 12px 16px; z-index: 1600; font-size: 16px; font-weight: 600; box-shadow: var(--shadow-sm); height: 60px; align-items: center; justify-content: center; }
        .mobile-header-title { flex: 1; text-align: center; font-size: 14px; color: var(--text-primary); font-weight: 600; display: flex; align-items: center; justify-content: space-between; }
        .mobile-header-title i { margin-right: 8px; color: var(--primary-color); }
        .mobile-menu-btn { position: absolute; right: 16px; top: 50%; transform: translateY(-50%); background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 8px; padding: 10px; color: var(--text-primary); font-size: 16px; cursor: pointer; transition: all 0.3s ease; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; }
        .mobile-menu-btn:hover { background: var(--primary-color); color: #fff; border-color: var(--primary-color); }
        .mobile-nav { display: none; position: fixed; top: 0; right: -100%; width: 280px; height: 100vh; background: var(--card-bg); transition: right 0.3s ease; z-index: 1700; overflow-y: auto; box-shadow: var(--shadow-xl); border-left: 1px solid var(--border-color); padding: 24px; flex-direction: column; }
        .mobile-nav.active { right: 0; }
        .mobile-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); backdrop-filter: blur(4px); z-index: 1650; }
        .mobile-overlay.active { display: block; }
        
        /* Footer Copyright */
        .footer-copyright { margin-top: 40px; padding: 20px 0; border-top: 1px solid var(--border-light); text-align: center; color: var(--text-muted); font-size: 12px; line-height: 1.5; }
        .hidden { display: none !important; }
        
        .notification { position: fixed; top: 20px; right: 20px; padding: 16px 20px; border-radius: 12px; color: #fff; font-weight: 600; z-index: 2100; animation: slideInRight 0.3s ease; max-width: 320px; box-shadow: var(--shadow-lg); backdrop-filter: blur(10px); }
        .notification.success { background: var(--success-color); }
        .notification.error { background: var(--danger-color); }
        .notification.warning { background: var(--warning-color); }
        @keyframes slideInRight { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

        /* Chart containers */
        .chart-container { background: var(--card-bg); padding: 24px; border-radius: 16px; box-shadow: var(--shadow-md); border: 1px solid var(--border-color); }
        .chart-title { color: var(--text-primary); font-size: 16px; font-weight: 600; margin-bottom: 20px; text-align: center; }

        /* Loading overlay */
        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); backdrop-filter: blur(4px); display: flex; align-items: center; justify-content: center; z-index: 2200; }
        .loading-content { background: var(--card-bg); padding: 32px; border-radius: 16px; text-align: center; box-shadow: var(--shadow-xl); border: 1px solid var(--border-color); }
        .loading-content .loading-spinner { width: 32px; height: 32px; border-width: 3px; margin: 0 auto 16px; }
        .loading-text { color: var(--text-primary); font-weight: 600; font-size: 16px; }

        /* Section Loading Indicator */
        .section-loading { display: flex; align-items: center; justify-content: center; padding: 60px 20px; color: var(--text-secondary); font-size: 16px; gap: 12px; }
        .section-loading .loading-spinner { width: 24px; height: 24px; border-width: 2px; }

        /* Settings Form Styles */
        .settings-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-bottom: 24px; }
        .settings-section { background: var(--bg-secondary); padding: 24px; border-radius: 12px; border: 1px solid var(--border-light); }
        .settings-title { color: var(--text-primary); font-size: 18px; font-weight: 600; margin-bottom: 20px; display: flex; align-items: center; gap: 8px; }
        .admin-profile-section { background: var(--bg-secondary); padding: 24px; border-radius: 12px; margin-bottom: 24px; border: 1px solid var(--border-light); }
        
        /* Users Section Specifics */
        .users-controls { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; margin-bottom: 24px; }
        .users-pagination { display: flex; justify-content: center; align-items: center; gap: 8px; margin-top: 24px; }
        .pagination-btn { background: var(--bg-secondary); color: var(--text-primary); border: 1px solid var(--border-color); border-radius: 8px; padding: 8px 12px; cursor: pointer; transition: all 0.2s ease; }
        .pagination-btn:hover { background: var(--primary-color); color: #fff; }
        .pagination-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .pagination-info { font-size: 13px; color: var(--text-secondary); }
        .qr-code-container { background: #fff; padding: 10px; border-radius: 8px; margin: 16px auto; width: 170px; height: 170px; display: flex; align-items: center; justify-content: center; }
        .subscription-link-container { display: flex; align-items: center; gap: 8px; margin-top: 16px; }
        .subscription-link-input { flex-grow: 1; direction: ltr; text-align: left; }
        
        /* API Status Info */
        .api-status-info {
            background: rgba(245, 158, 11, 0.1);
            border: 1px solid rgba(245, 158, 11, 0.2);
            border-radius: 8px;
            padding: 12px 16px;
            margin-bottom: 16px;
            font-size: 13px;
            color: var(--warning-color);
        }
        
        /* User Modal Tabs */
        .modal-tabs { display: flex; border-bottom: 1px solid var(--border-color); margin-bottom: 24px; }
        .modal-tab-btn { padding: 10px 20px; cursor: pointer; background: none; border: none; color: var(--text-secondary); font-weight: 600; font-size: 14px; border-bottom: 3px solid transparent; transition: all 0.3s ease; }
        .modal-tab-btn.active { color: var(--primary-color); border-bottom-color: var(--primary-color); }
        .modal-tab-content { display: none; }
        .modal-tab-content.active { display: block; }
        #userFormProxies { min-height: 200px; direction: ltr; text-align: left; font-family: 'Courier New', Courier, monospace !important; font-size: 13px; }

        /* Responsive Design */
        @media (max-width: 768px) {
            .panel-content { margin-right: 0 !important; padding: 12px; padding-top: 75px; width: 100vw; max-width: 100vw; overflow-x: hidden; }
            .panel-nav { display: none !important; }
            .mobile-header, .mobile-nav { display: flex !important; }
            .content-header { font-size: 20px; margin-bottom: 16px; }
            .section-header { flex-direction: column; align-items: flex-start; gap: 12px; }
            .stats-grid, .system-grid, .settings-grid { grid-template-columns: 1fr !important; gap: 12px; }
            .stats-card, .system-card { padding: 14px; }
            .stats-number, .system-value { font-size: 18px; }
            .data-table { display: block; overflow-x: auto; white-space: nowrap; }
            .modal-content { max-width: calc(100vw - 24px); }
            .chart-container { grid-column: span 1 !important; }
        }
        @media (min-width: 769px) {
            .mobile-header, .mobile-nav, .mobile-overlay { display: none !important; }
        }
    </style>
</head>
<body>
    <!-- Theme Toggle -->
    <div class="theme-toggle" onclick="toggleTheme()">
        <i class="fas fa-sun" id="themeIcon"></i>
    </div>

    <!-- Connection Status Indicator -->
    <div id="connectionIndicator" class="connection-indicator disconnected">
        <i class="fas fa-unlink"></i>
        <span>قطع</span>
    </div>

    <!-- Server URL Setting -->
    <div class="server-setting" onclick="showSection('settings')">
        <i class="fas fa-server"></i>
        <span>تنظیم سرور</span>
    </div>

    <!-- Login Section -->
    <div id="loginSection" class="login-container">
        <div class="login-card">
            <div class="login-header">
                <div class="login-logo">👑</div>
                <h1 class="login-title">پنل مدیریت</h1>
                <p class="login-subtitle">طوفان سرور - ادمین</p>
            </div>
            
            <form id="loginForm">
                <div class="form-group">
                    <label class="form-label">نام کاربری</label>
                    <input type="text" id="username" class="form-input" placeholder="نام کاربری ادمین" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">رمز عبور</label>
                    <input type="password" id="password" class="form-input" placeholder="رمز عبور ادمین" required>
                </div>
                
                <div id="loginError" class="error-message hidden"></div>
                
                <button type="submit" id="loginBtn" class="login-btn">
                    <span id="loginBtnText">ورود به پنل مدیریت</span>
                    <div id="loginSpinner" class="loading-spinner hidden"></div>
                </button>
            </form>

            <div class="login-footer">
                <div class="login-copyright">
                    پنل مدیریت طوفان سرور - دسترسی محدود به مدیران
                </div>
            </div>
        </div>
    </div>

    <!-- Main Panel Section -->
    <div id="panelSection" class="panel-container hidden">
        <!-- Mobile Header -->
        <div class="mobile-header">
            <div class="mobile-header-title">
                <i class="fas fa-crown"></i>
                پنل مدیریت طوفان سرور
            </div>
            <button class="mobile-menu-btn" onclick="toggleMobileMenu()">
                <i class="fas fa-bars"></i>
            </button>
        </div>
        
        <div id="mobileOverlay" class="mobile-overlay" onclick="toggleMobileMenu()"></div>
        
        <div id="mobileNav" class="mobile-nav">
            <div class="nav-header">
                <div class="nav-logo">👑</div>
                <div class="nav-title">پنل مدیریت</div>
                <div class="nav-subtitle" id="navWelcomeMobile">خوش آمدید</div>
            </div>
            
            <div class="nav-menu">
                <button class="nav-item active" data-section="dashboard" onclick="showSection('dashboard'); toggleMobileMenu()"><span>داشبورد</span><i class="fas fa-tachometer-alt"></i></button>
                <button class="nav-item" data-section="users" onclick="showSection('users'); toggleMobileMenu()"><span>مدیریت کاربران</span><i class="fas fa-users"></i></button>
                <button class="nav-item" data-section="system" onclick="showSection('system'); toggleMobileMenu()"><span>وضعیت سیستم</span><i class="fas fa-server"></i></button>
                <button class="nav-item" data-section="monitor" onclick="showSection('monitor'); toggleMobileMenu()"><span>مانیتورینگ نمایندگان</span><i class="fas fa-eye"></i></button>
                <button class="nav-item" data-section="analytics" onclick="showSection('analytics'); toggleMobileMenu()"><span>آمار و گزارش</span><i class="fas fa-chart-area"></i></button>
                <button class="nav-item" data-section="logs" onclick="showSection('logs'); toggleMobileMenu()"><span>لاگ ورود نمایندگان</span><i class="fas fa-history"></i></button>
                <button class="nav-item" data-section="admins" onclick="showSection('admins'); toggleMobileMenu()"><span>مدیریت ادمین‌ها</span><i class="fas fa-user-shield"></i></button>
                <button class="nav-item" data-section="settings" onclick="showSection('settings'); toggleMobileMenu()"><span>تنظیمات</span><i class="fas fa-cog"></i></button>
            </div>
            
            <div class="nav-footer">
                <button class="logout-btn" onclick="logout()"><i class="fas fa-sign-out-alt"></i> خروج</button>
            </div>
        </div>
        
        <!-- Side Navigation -->
        <div class="panel-nav">
            <div class="nav-header">
                <div class="nav-logo">👑</div>
                <div class="nav-title">پنل مدیریت</div>
                <div class="nav-subtitle" id="navWelcome">خوش آمدید</div>
            </div>
            
            <div class="nav-menu">
                <button class="nav-item active" data-section="dashboard" onclick="showSection('dashboard')"><span>داشبورد</span><i class="fas fa-tachometer-alt"></i></button>
                <button class="nav-item" data-section="users" onclick="showSection('users')"><span>مدیریت کاربران</span><i class="fas fa-users"></i></button>
                <button class="nav-item" data-section="system" onclick="showSection('system')"><span>وضعیت سیستم</span><i class="fas fa-server"></i></button>
                <button class="nav-item" data-section="monitor" onclick="showSection('monitor')"><span>مانیتورینگ نمایندگان</span><i class="fas fa-eye"></i></button>
                <button class="nav-item" data-section="analytics" onclick="showSection('analytics')"><span>آمار و گزارش</span><i class="fas fa-chart-area"></i></button>
                <button class="nav-item" data-section="logs" onclick="showSection('logs')"><span>لاگ ورود نمایندگان</span><i class="fas fa-history"></i></button>
                <button class="nav-item" data-section="admins" onclick="showSection('admins')"><span>مدیریت ادمین‌ها</span><i class="fas fa-user-shield"></i></button>
                <button class="nav-item" data-section="settings" onclick="showSection('settings')"><span>تنظیمات</span><i class="fas fa-cog"></i></button>
            </div>
            
            <div class="nav-footer">
                <button class="logout-btn" onclick="logout()"><i class="fas fa-sign-out-alt"></i> خروج</button>
            </div>
        </div>

        <!-- Content -->
        <div class="panel-content">
            <h1 class="content-header">پنل مدیریت طوفان سرور</h1>
            
            <!-- Dashboard Section -->
            <div id="dashboardSection" class="content-section active">
                <div class="section-header">
                    <h3 class="section-title"><i class="fas fa-tachometer-alt"></i> داشبورد مدیریت</h3>
                    <button class="refresh-btn" id="refreshDashboardBtn" onclick="refreshDashboard()"><i class="fas fa-sync-alt"></i> <span>بروزرسانی</span><div class="loading-spinner hidden"></div></button>
                </div>
                <div class="stats-grid">
                    <div class="stats-card"><div class="stats-icon"><i class="fas fa-users"></i></div><div class="stats-number" id="totalUsers">0</div><div class="stats-label">کل کاربران</div></div>
                    <div class="stats-card"><div class="stats-icon"><i class="fas fa-user-shield"></i></div><div class="stats-number" id="totalReps">0</div><div class="stats-label">نمایندگان فعال</div></div>
                    <div class="stats-card"><div class="stats-icon"><i class="fas fa-globe"></i></div><div class="stats-number" id="onlineUsers">0</div><div class="stats-label">کاربران آنلاین</div></div>
                    <div class="stats-card"><div class="stats-icon"><i class="fas fa-download"></i></div><div class="stats-number" id="totalTraffic">0 GB</div><div class="stats-label">ترافیک امروز</div></div>
                </div>
                <div id="dashboardChartContainer" style="display: grid; grid-template-columns: 1fr; gap: 24px; margin-bottom: 24px;">
                    <!-- Chart will be injected here -->
                </div>
            </div>

            <!-- Users Management Section -->
            <div id="usersSection" class="content-section">
                <div class="section-header">
                    <h3 class="section-title"><i class="fas fa-users"></i> مدیریت کاربران</h3>
                    <button class="refresh-btn" onclick="refreshUsersSection()"><i class="fas fa-sync-alt"></i> بروزرسانی</button>
                </div>
                <div class="users-controls">
                    <input type="text" id="userSearch" placeholder="جستجوی نام کاربری..." class="search-box" style="flex: 1; min-width: 250px; margin-bottom: 0;">
                    <button onclick="handleUserSearch()" class="form-button"><i class="fas fa-search"></i> جستجو</button>
                    <button onclick="showUserModal()" class="form-button success"><i class="fas fa-plus"></i> کاربر جدید</button>
                </div>
                <div id="usersContent">
                    <div class="section-loading"><div class="loading-spinner"></div><span>در حال بارگذاری کاربران...</span></div>
                </div>
                <div id="usersPagination" class="users-pagination"></div>
            </div>

            <!-- System Status Section -->
            <div id="systemSection" class="content-section">
                <div class="section-header">
                    <h3 class="section-title"><i class="fas fa-server"></i> وضعیت سیستم</h3>
                    <button class="refresh-btn" onclick="refreshSystemSection()"><i class="fas fa-sync-alt"></i> بروزرسانی</button>
                </div>
                <div class="system-grid">
                    <div class="system-card"><div class="system-icon"><i class="fas fa-microchip"></i></div><div class="system-title">مصرف CPU</div><div class="system-value" id="cpuUsage">0%</div><div class="system-details"><div class="progress-bar"><div class="progress-fill" id="cpuProgress" style="width: 0%;"></div></div></div></div>
                    <div class="system-card"><div class="system-icon"><i class="fas fa-memory"></i></div><div class="system-title">مصرف RAM</div><div class="system-value" id="ramUsage">0%</div><div class="system-details"><div class="progress-bar"><div class="progress-fill" id="ramProgress" style="width: 0%;"></div></div><small id="ramDetails">0 GB / 0 GB</small></div></div>
                    <div class="system-card"><div class="system-icon"><i class="fas fa-database"></i></div><div class="system-title">فضای دیسک</div><div class="system-value" id="diskUsage">0%</div><div class="system-details"><div class="progress-bar"><div class="progress-fill" id="diskProgress" style="width: 0%;"></div></div><small id="diskDetails">0 GB / 0 GB</small></div></div>
                    <div class="system-card"><div class="system-icon"><i class="fas fa-network-wired"></i></div><div class="system-title">پهنای باند</div><div class="system-value" id="bandwidthUsage">0 MB/s</div><div class="system-details"><small>⬇️ <span id="downloadSpeed">0 MB/s</span></small> <small>⬆️ <span id="uploadSpeed">0 MB/s</span></small></div></div>
                </div>
            </div>

            <!-- Representatives Monitor Section -->
            <div id="monitorSection" class="content-section">
                <div class="section-header">
                    <h3 class="section-title"><i class="fas fa-eye"></i> مانیتورینگ نمایندگان</h3>
                    <button class="refresh-btn" id="refreshMonitorBtn" onclick="refreshMonitorSection()"><i class="fas fa-sync-alt"></i> <span>بروزرسانی</span><div class="loading-spinner hidden"></div></button>
                </div>
                <div class="users-controls">
                    <input type="text" id="repSearch" placeholder="جستجوی نام نماینده..." class="search-box" style="flex: 1; min-width: 250px; margin-bottom: 0;" onkeyup="handleRepSearch()">
                </div>
                <div class="admin-profile-section">
                    <h4 style="font-size: 18px; font-weight: 600; margin-bottom: 20px;">افزودن نماینده به مانیتورینگ</h4>
                    <form id="addMonitorForm">
                        <div class="form-grid" style="grid-template-columns: 1fr 1fr;">
                            <div class="form-group"><label class="form-label">نام نمایشی</label><input type="text" id="monitorDisplayName" class="form-input" placeholder="مثلا: نماینده تهران" required></div>
                            <div class="form-group"><label class="form-label">آدرس پنل نماینده</label><input type="url" id="monitorServerUrl" class="form-input" placeholder="https://reseller.example.com:8000" required></div>
                            <div class="form-group"><label class="form-label">نام کاربری نماینده</label><input type="text" id="monitorUsername" class="form-input" placeholder="نام کاربری ادمین نماینده" required></div>
                            <div class="form-group"><label class="form-label">رمز عبور نماینده</label><input type="password" id="monitorPassword" class="form-input" placeholder="رمز عبور ادمین نماینده" required></div>
                        </div>
                        <div id="addMonitorError" class="error-message hidden"></div>
                        <button type="submit" id="addMonitorBtn" class="form-button" style="width: 100%; padding: 14px;"><span><i class="fas fa-plus"></i> افزودن به مانیتورینگ</span><div class="loading-spinner hidden"></div></button>
                    </form>
                </div>
                <div id="representativesContent"><div class="section-loading"><div class="loading-spinner"></div><span>در حال بارگذاری نمایندگان...</span></div></div>
            </div>

            <!-- Analytics Section -->
            <div id="analyticsSection" class="content-section">
                <div class="section-header">
                    <h3 class="section-title"><i class="fas fa-chart-area"></i> آمار و گزارش‌ها</h3>
                    <button class="refresh-btn" id="refreshAnalyticsBtn" onclick="loadAnalyticsData()"><i class="fas fa-sync-alt"></i> <span>بروزرسانی</span><div class="loading-spinner hidden"></div></button>
                </div>
                <div id="analyticsContent">
                    <div class="section-loading"><div class="loading-spinner"></div><span>در حال بارگذاری گزارش‌ها...</span></div>
                </div>
            </div>

            <!-- Logs Section -->
            <div id="logsSection" class="content-section">
                <div class="section-header">
                    <h3 class="section-title"><i class="fas fa-history"></i> لاگ ورود نمایندگان</h3>
                    <button class="refresh-btn" onclick="loadRepLogs()"><i class="fas fa-sync-alt"></i> بروزرسانی</button>
                </div>
                <div id="repLogsContainer">
                    <div class="section-loading"><span>لاگ‌ها در حال بارگذاری هستند...</span></div>
                </div>
            </div>

            <!-- Admins Management Section -->
            <div id="adminsSection" class="content-section">
                <div class="section-header">
                    <h3 class="section-title"><i class="fas fa-user-shield"></i> مدیریت ادمین‌ها</h3>
                    <button class="form-button success" onclick="showAdminModal()"><i class="fas fa-plus"></i> افزودن ادمین جدید</button>
                </div>
                <div class="admin-profile-section" style="background: rgba(245, 158, 11, 0.1); border-color: rgba(245, 158, 11, 0.2); color: var(--warning-color);">
                    <i class="fas fa-exclamation-triangle"></i> <strong>توجه:</strong> مدیریت ادمین‌های این پنل (نه سرور Marzban) به صورت محلی و در حافظه مرورگر انجام می‌شود.
                </div>
                <div id="adminsTableContainer">
                    <div class="section-loading"><div class="loading-spinner"></div><span>در حال بارگذاری لیست ادمین‌ها...</span></div>
                </div>
            </div>

            <!-- Settings Section -->
            <div id="settingsSection" class="content-section">
                <div class="section-header">
                    <h3 class="section-title"><i class="fas fa-cog"></i> تنظیمات پنل</h3>
                </div>
                <div class="api-status-info">
                    <i class="fas fa-info-circle"></i> <strong>توجه:</strong> برای برقراری اتصال، endpoint های مختلف API Marzban بررسی می‌شود. معمولاً <code>/api/admin/token</code> استفاده می‌شود.
                </div>
                <div class="settings-grid">
                    <div class="settings-section">
                        <h4 class="settings-title"><i class="fas fa-server"></i> سرور اصلی Marzban</h4>
                        <form id="mainServerForm">
                            <div class="form-group">
                                <label class="form-label">آدرس سرور (با پورت)</label>
                                <input type="url" id="mainServerUrl" class="form-input" placeholder="https://example.com:8000" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">نام کاربری ادمین</label>
                                <input type="text" id="mainServerUsername" class="form-input" placeholder="نام کاربری sudo" required>
                            </div>
                             <div class="form-group">
                                <label class="form-label">رمز عبور ادمین</label>
                                <input type="password" id="mainServerPassword" class="form-input" placeholder="رمز عبور sudo" required>
                            </div>
                            <div style="display: flex; gap: 12px;">
                                <button type="submit" id="saveMainServerBtn" class="form-button success" style="flex: 1;"><span><i class="fas fa-save"></i> ذخیره</span><div class="loading-spinner hidden"></div></button>
                                <button type="button" id="testMainServerBtn" onclick="testMainServerConnection()" class="form-button info" style="flex: 1;"><span><i class="fas fa-plug"></i> تست اتصال</span><div class="loading-spinner hidden"></div></button>
                            </div>
                        </form>
                    </div>
                    <div class="settings-section">
                        <h4 class="settings-title"><i class="fas fa-user-shield"></i> پروفایل ادمین پنل</h4>
                        <form id="changePasswordForm">
                            <div class="form-group">
                                <label class="form-label">نام کاربری</label>
                                <input type="text" id="currentAdminUsername" class="form-input" readonly>
                            </div>
                            <div class="form-group">
                                <label class="form-label">رمز عبور جدید</label>
                                <input type="password" id="newAdminPassword" class="form-input" placeholder="حداقل 8 کاراکتر" required>
                            </div>
                            <button type="submit" class="form-button" style="width: 100%;"><i class="fas fa-key"></i> تغییر رمز عبور</button>
                        </form>
                    </div>
                </div>
            </div>
            
            <div class="footer-copyright">پنل مدیریت طوفان سرور - © 2025</div>
        </div>
    </div>

    <!-- User Details Modal -->
    <div id="userModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="userModalTitle"><i class="fas fa-user-edit"></i> ویرایش کاربر</h3>
                <button class="modal-close" onclick="closeUserModal()"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-tabs">
                <button id="userModalTabInfo" class="modal-tab-btn active" onclick="switchUserModalTab('info')">اطلاعات اصلی</button>
                <button id="userModalTabConfig" class="modal-tab-btn" onclick="switchUserModalTab('config')">تنظیمات کانفیگ</button>
            </div>
            <div id="userModalContent">
                <form id="userForm">
                    <input type="hidden" id="userModalUsername">
                    <!-- Tab 1: Main Info -->
                    <div id="userModalContentInfo" class="modal-tab-content active">
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label">نام کاربری</label>
                                <input type="text" id="userFormUsername" class="form-input" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">ترافیک (GB)</label>
                                <input type="number" id="userFormTraffic" class="form-input" placeholder="0 برای نامحدود" min="0">
                            </div>
                            <div class="form-group">
                                <label class="form-label">تاریخ انقضا</label>
                                <input type="date" id="userFormExpiry" class="form-input">
                            </div>
                             <div class="form-group">
                                <label class="form-label">وضعیت</label>
                                <select id="userFormStatus" class="form-input">
                                    <option value="active">فعال</option>
                                    <option value="disabled">غیرفعال</option>
                                    <option value="expired">منقضی</option>
                                    <option value="limited">محدود شده</option>
                                </select>
                            </div>
                        </div>
                        <div id="userModalDetails" class="hidden" style="margin-top: 24px; border-top: 1px solid var(--border-light); padding-top: 24px;">
                            <h4 class="settings-title">اطلاعات اتصال</h4>
                            <div class="qr-code-container" id="qrCodeContainer">
                                <div class="loading-spinner"></div>
                            </div>
                            <div class="subscription-link-container">
                                <input type="text" id="subscriptionLink" class="form-input subscription-link-input" readonly>
                                <button type="button" class="form-button" onclick="copySubscriptionLink()"><i class="fas fa-copy"></i></button>
                            </div>
                        </div>
                    </div>
                    <!-- Tab 2: Config/Proxies -->
                    <div id="userModalContentConfig" class="modal-tab-content">
                        <div class="form-group">
                            <label class="form-label">پیکربندی Proxies (فرمت JSON)</label>
                            <p class="api-status-info" style="font-size: 12px; margin-bottom: 12px;">
                                <i class="fas fa-exclamation-triangle"></i> <strong>احتیاط:</strong> ویرایش این بخش نیازمند آشنایی کامل با ساختار Marzban است. هرگونه تغییر اشتباه می‌تواند منجر به قطع اتصال کاربر شود.
                            </p>
                            <textarea id="userFormProxies" class="form-input"></textarea>
                        </div>
                    </div>
                    <div id="userFormError" class="error-message hidden"></div>
                    <button type="submit" class="form-button success" style="width:100%; padding: 12px; margin-top: 20px;">
                        <i class="fas fa-save"></i> <span id="userFormSubmitText">ذخیره تغییرات</span>
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Admin Modal -->
    <div id="adminModal" class="modal hidden">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3 class="modal-title" id="adminModalTitle">افزودن ادمین جدید</h3>
                <button class="modal-close" onclick="closeAdminModal()"><i class="fas fa-times"></i></button>
            </div>
            <form id="adminForm">
                <input type="hidden" id="originalAdminUsername">
                <div class="form-group">
                    <label class="form-label">نام کاربری</label>
                    <input type="text" id="adminFormUsername" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">رمز عبور</label>
                    <input type="password" id="adminFormPassword" class="form-input" required>
                </div>
                <div id="adminFormError" class="error-message hidden"></div>
                <button type="submit" class="form-button success" style="width:100%; padding: 12px;"><i class="fas fa-save"></i> ذخیره</button>
            </form>
        </div>
    </div>
    
    <div id="loadingOverlay" class="loading-overlay hidden">
        <div class="loading-content"><div class="loading-spinner"></div><p class="loading-text">منتظر بمانید...</p></div>
    </div>

    <script>
        // --- CONFIGURATION & KEYS ---
        const CONFIG_KEYS = {
            sessionToken: 'toofan_admin_session_token',
            adminUsername: 'toofan_admin_username',
            mainServer: 'toofan_main_server_config_v2',
            monitoredReps: 'toofan_monitored_reps_v2',
            adminCredentials: 'toofan_admin_credentials',
            theme: 'toofan_theme',
            repLoginLogs: 'toofan_rep_login_logs'
        };

        const DEFAULTS = {
            usersPerPage: 20,
            initialAdmin: { shahriyar: 'shahriyarpanel112' }
        };

        // --- MARZBAN API HELPER ---
        const MarzbanAPI = {
            async login(serverUrl, username, password) {
                const endpoints = ['/api/admin/token', '/api/admin/login', '/api/token', '/api/login/access-token'];
                let lastError = null;
                for (const endpoint of endpoints) {
                    try {
                        const requestUrl = `${serverUrl}${endpoint}`;
                        const formData = new FormData();
                        formData.append('username', username);
                        formData.append('password', password);
                        let response = await fetch(requestUrl, { method: 'POST', body: formData, headers: { 'Accept': 'application/json' } });
                        if (response.ok) {
                            const data = await response.json();
                            return data;
                        } else {
                            const errorData = await response.json().catch(() => ({ detail: `HTTP ${response.status}` }));
                            lastError = new Error(errorData.detail || `خطای ${response.status}`);
                        }
                    } catch (error) {
                        lastError = error;
                        continue;
                    }
                }
                if (lastError instanceof TypeError || lastError.message.includes('fetch')) {
                    throw new Error('خطا در شبکه یا CORS. آدرس سرور و تنظیمات شبکه را بررسی کنید.');
                }
                throw lastError || new Error('نام کاربری یا رمز عبور اشتباه است یا سرور در دسترس نیست');
            },
            async request(serverUrl, token, endpoint, options = {}) {
                const response = await fetch(`${serverUrl}${endpoint}`, {
                    ...options,
                    headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json', 'Accept': 'application/json', ...options.headers }
                });
                if (!response.ok) {
                     const errorData = await response.json().catch(() => ({ detail: `خطای ${response.status}` }));
                     throw new Error(errorData.detail || `API Error: ${response.status}`);
                }
                return response.status !== 204 ? await response.json() : null;
            },
            getUsers: (url, token, params) => MarzbanAPI.request(url, token, `/api/users?${new URLSearchParams(params)}`),
            getUser: (url, token, username) => MarzbanAPI.request(url, token, `/api/user/${username}`),
            addUser: (url, token, userData) => MarzbanAPI.request(url, token, '/api/user', { method: 'POST', body: JSON.stringify(userData) }),
            modifyUser: (url, token, username, userData) => MarzbanAPI.request(url, token, `/api/user/${username}`, { method: 'PUT', body: JSON.stringify(userData) }),
            deleteUser: (url, token, username) => MarzbanAPI.request(url, token, `/api/user/${username}`, { method: 'DELETE' }),
            resetUserTraffic: (url, token, username) => MarzbanAPI.request(url, token, `/api/user/${username}/reset`, { method: 'POST' }),
            getSystemInfo: (url, token) => MarzbanAPI.request(url, token, '/api/system'),
        };

        // --- GLOBAL VARIABLES ---
        let mainServer = null;
        let sectionsLoaded = {};
        let chartInstances = {};
        let monitoredRepsCache = [];

        // --- UTILITY & UI FUNCTIONS ---
        const setLoadingState = (btn, loading) => {
            if (!btn) return;
            btn.disabled = loading;
            const spinner = btn.querySelector('.loading-spinner');
            const btnTextSpan = btn.querySelector('span');
            if (loading) {
                if(btnTextSpan) btnTextSpan.style.opacity = '0';
                if (spinner) spinner.classList.remove('hidden');
            } else {
                if(btnTextSpan) btnTextSpan.style.opacity = '1';
                if (spinner) spinner.classList.add('hidden');
            }
        };
        const showNotification = (message, type = 'success') => {
            const el = document.createElement('div');
            el.className = `notification ${type}`;
            el.innerHTML = `<i class="fas fa-${type === 'success' ? 'check' : type === 'error' ? 'times' : 'exclamation'}-circle"></i> ${message}`;
            document.body.appendChild(el);
            setTimeout(() => el.remove(), 4000);
        };
        const formatBytes = (bytes, decimals = 2) => {
            if (!+bytes) return '0 Bytes';
            const k = 1024;
            const dm = decimals < 0 ? 0 : decimals;
            const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return `${parseFloat((bytes / Math.pow(k, i)).toFixed(dm))} ${sizes[i]}`;
        };
        const updateConnectionStatus = (status) => {
            const indicator = document.getElementById('connectionIndicator');
            indicator.className = `connection-indicator ${status}`;
            const icon = status === 'connected' ? 'link' : status === 'disconnected' ? 'unlink' : 'spinner fa-spin';
            const text = status === 'connected' ? 'متصل' : status === 'disconnected' ? 'قطع' : 'در حال اتصال';
            indicator.innerHTML = `<i class="fas fa-${icon}"></i><span>${text}</span>`;
        };
        const destroyChart = (chartId) => {
            if (chartInstances[chartId]) {
                chartInstances[chartId].destroy();
                delete chartInstances[chartId];
            }
        };

        // --- THEME MANAGEMENT ---
        const initTheme = () => {
            const savedTheme = localStorage.getItem(CONFIG_KEYS.theme) || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
            setTheme(savedTheme);
        };
        const setTheme = (theme) => {
            document.documentElement.setAttribute('data-theme', theme);
            document.getElementById('themeIcon').className = `fas fa-${theme === 'dark' ? 'moon' : 'sun'}`;
            localStorage.setItem(CONFIG_KEYS.theme, theme);
            Object.values(chartInstances).forEach(chart => {
                const isDark = theme === 'dark';
                const textColor = isDark ? '#F8FAFC' : '#1E293B';
                const gridColor = isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
                if (chart.options.scales.x) chart.options.scales.x.ticks.color = textColor;
                if (chart.options.scales.y) chart.options.scales.y.ticks.color = textColor;
                if (chart.options.scales.x) chart.options.scales.x.grid.color = gridColor;
                if (chart.options.scales.y) chart.options.scales.y.grid.color = gridColor;
                if (chart.options.plugins.legend) chart.options.plugins.legend.labels.color = textColor;
                chart.update();
            });
        };
        const toggleTheme = () => setTheme(document.documentElement.getAttribute('data-theme') === 'dark' ? 'light' : 'dark');

        // --- AUTHENTICATION & ADMINS ---
        const getAdminCredentials = () => JSON.parse(localStorage.getItem(CONFIG_KEYS.adminCredentials)) || DEFAULTS.initialAdmin;
        const saveAdminCredentials = (creds) => localStorage.setItem(CONFIG_KEYS.adminCredentials, JSON.stringify(creds));
        const handleLogin = async (e) => {
            e.preventDefault();
            const loginBtn = document.getElementById('loginBtn');
            setLoadingState(loginBtn, true);
            document.getElementById('loginError').classList.add('hidden');
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const admins = getAdminCredentials();
            if (admins[username] && admins[username] === password) {
                sessionStorage.setItem(CONFIG_KEYS.sessionToken, `local_token_${Date.now()}`);
                sessionStorage.setItem(CONFIG_KEYS.adminUsername, username);
                showPanel();
            } else {
                document.getElementById('loginError').textContent = "نام کاربری یا رمز عبور پنل ادمین اشتباه است.";
                document.getElementById('loginError').classList.remove('hidden');
            }
            setLoadingState(loginBtn, false);
        };
        const showPanel = () => {
            document.getElementById('loginSection').classList.add('hidden');
            document.getElementById('panelSection').classList.remove('hidden');
            const username = sessionStorage.getItem(CONFIG_KEYS.adminUsername);
            document.getElementById('navWelcome').textContent = `خوش آمدید، ${username}`;
            document.getElementById('navWelcomeMobile').textContent = `خوش آمدید، ${username}`;
            loadMainServerConfig();
            showSection('dashboard');
        };
        const logout = () => {
            sessionStorage.clear();
            location.reload();
        };
        const checkSession = () => {
            if (sessionStorage.getItem(CONFIG_KEYS.sessionToken)) {
                showPanel();
            }
        };

        // --- SERVER CONFIG ---
        const loadMainServerConfig = () => {
            const stored = localStorage.getItem(CONFIG_KEYS.mainServer);
            if (stored) {
                mainServer = JSON.parse(stored);
                updateConnectionStatus('connected');
            } else {
                mainServer = null;
                updateConnectionStatus('disconnected');
                showNotification('پیکربندی سرور اصلی یافت نشد. لطفا به بخش تنظیمات بروید.', 'warning');
            }
        };

        // --- SECTION MANAGEMENT ---
        const showSection = (sectionName) => {
            document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            document.getElementById(`${sectionName}Section`).classList.add('active');
            document.querySelectorAll(`.nav-item[data-section="${sectionName}"]`).forEach(i => i.classList.add('active'));
            const alwaysReload = ['dashboard', 'system', 'monitor', 'analytics', 'logs'];
            if (!sectionsLoaded[sectionName] || alwaysReload.includes(sectionName)) {
                const loader = {
                    'dashboard': loadDashboardData,
                    'users': () => loadUsers(1),
                    'system': loadSystemStatus,
                    'monitor': refreshMonitorSection,
                    'analytics': loadAnalyticsData,
                    'admins': loadAdmins,
                    'settings': loadSettings,
                    'logs': loadRepLogs,
                }[sectionName];
                if (loader) loader();
                sectionsLoaded[sectionName] = true;
            }
        };
        const toggleMobileMenu = () => {
            document.getElementById('mobileNav').classList.toggle('active');
            document.getElementById('mobileOverlay').classList.toggle('active');
        };

        // --- DASHBOARD ---
        const loadDashboardData = async () => {
            const btn = document.getElementById('refreshDashboardBtn');
            setLoadingState(btn, true);
            const chartContainer = document.getElementById('dashboardChartContainer');
            chartContainer.innerHTML = '<div class="section-loading"><div class="loading-spinner"></div></div>';

            if (!mainServer || !mainServer.token) {
                showNotification('اتصال به سرور اصلی برقرار نیست. لطفا تنظیمات را بررسی کنید.', 'error');
                chartContainer.innerHTML = '<div class="section-loading">اتصال به سرور برقرار نیست.</div>';
                setLoadingState(btn, false);
                return;
            }
            try {
                const [usersData, systemData] = await Promise.all([
                    MarzbanAPI.getUsers(mainServer.serverUrl, mainServer.token, {limit: 0}),
                    MarzbanAPI.getSystemInfo(mainServer.serverUrl, mainServer.token)
                ]);
                const users = usersData.users;
                const onlineUsers = users.filter(u => u.online_at && (new Date() - new Date(u.online_at) < 300000)).length;
                const totalTrafficToday = users.reduce((acc, u) => acc + (u.used_traffic || 0), 0);
                const totalAdmins = Object.keys(getAdminCredentials()).length;
                const totalReps = (JSON.parse(localStorage.getItem(CONFIG_KEYS.monitoredReps)) || []).length;
                
                document.getElementById('totalUsers').textContent = usersData.total;
                document.getElementById('onlineUsers').textContent = onlineUsers;
                document.getElementById('totalTraffic').textContent = formatBytes(totalTrafficToday);
                document.getElementById('totalReps').textContent = totalReps;
                
                chartContainer.innerHTML = `
                    <div class="chart-container">
                        <h4 class="chart-title">آمار کلی سیستم</h4>
                        <div style="position: relative; height: 350px;">
                            <canvas id="overallSystemChart"></canvas>
                        </div>
                    </div>`;
                
                renderOverallSystemChart({
                    totalUsers: usersData.total,
                    totalTraffic: totalTrafficToday,
                    totalReps: totalReps,
                    totalAdmins: totalAdmins
                });
                setTheme(localStorage.getItem(CONFIG_KEYS.theme) || 'light');
            } catch (error) {
                showNotification(`خطا در بارگذاری داشبورد: ${error.message}`, 'error');
                chartContainer.innerHTML = `<div class="section-loading">خطا: ${error.message}</div>`;
            } finally {
                setLoadingState(btn, false);
            }
        };
        const refreshDashboard = () => loadDashboardData();

        // --- USER MANAGEMENT (Main Server) ---
        const loadUsers = async (page = 1, username = '') => {
            const usersContent = document.getElementById('usersContent');
            if (!mainServer || !mainServer.token) {
                usersContent.innerHTML = '<div class="section-loading">پیکربندی سرور اصلی یافت نشد. لطفا به تنظیمات بروید.</div>';
                return;
            }
            usersContent.innerHTML = '<div class="section-loading"><div class="loading-spinner"></div></div>';
            try {
                const params = { offset: (page - 1) * DEFAULTS.usersPerPage, limit: DEFAULTS.usersPerPage };
                if (username) params.username = username;
                const data = await MarzbanAPI.getUsers(mainServer.serverUrl, mainServer.token, params);
                renderUsersTable(data.users);
                renderUsersPagination(page, data.total, username);
            } catch (error) {
                usersContent.innerHTML = `<div class="section-loading">خطا: ${error.message}</div>`;
            }
        };
        const renderUsersTable = (users) => {
            const content = document.getElementById('usersContent');
            if (!users || users.length === 0) {
                content.innerHTML = '<div class="section-loading">کاربری یافت نشد.</div>';
                return;
            }
            const table = document.createElement('table');
            table.className = 'data-table';
            table.innerHTML = `
                <thead><tr><th>نام کاربری</th><th>وضعیت</th><th>ترافیک مصرفی</th><th>انقضا</th><th>عملیات</th></tr></thead>
                <tbody>
                    ${users.map(user => `
                        <tr>
                            <td><strong>${user.username}</strong></td>
                            <td><span class="status-badge status-${user.status}">${user.status}</span></td>
                            <td>${formatBytes(user.used_traffic)} / ${user.data_limit ? formatBytes(user.data_limit) : '∞'}</td>
                            <td>${user.expire ? new Date(user.expire * 1000).toLocaleDateString('fa-IR') : 'نامحدود'}</td>
                            <td>
                                <button class="form-button info" onclick="showUserModal('${user.username}')" title="مشاهده و ویرایش"><i class="fas fa-eye"></i></button>
                                <button class="form-button warning" onclick="resetUserTraffic('${user.username}')" title="ریست ترافیک"><i class="fas fa-sync-alt"></i></button>
                                <button class="form-button danger" onclick="deleteUser('${user.username}')" title="حذف کاربر"><i class="fas fa-trash"></i></button>
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            `;
            content.innerHTML = '';
            content.appendChild(table);
        };
        const renderUsersPagination = (currentPage, totalUsers, searchTerm = '') => {
            const pagination = document.getElementById('usersPagination');
            const totalPages = Math.ceil(totalUsers / DEFAULTS.usersPerPage);
            if (totalPages <= 1) { pagination.innerHTML = ''; return; }
            pagination.innerHTML = `
                <button class="pagination-btn" onclick="loadUsers(${currentPage - 1}, '${searchTerm}')" ${currentPage === 1 ? 'disabled' : ''}><i class="fas fa-chevron-right"></i></button>
                <span class="pagination-info">صفحه ${currentPage} از ${totalPages}</span>
                <button class="pagination-btn" onclick="loadUsers(${currentPage + 1}, '${searchTerm}')" ${currentPage >= totalPages ? 'disabled' : ''}><i class="fas fa-chevron-left"></i></button>
            `;
        };
        const handleUserSearch = () => loadUsers(1, document.getElementById('userSearch').value);
        const showUserModal = async (username = null) => {
            document.getElementById('userForm').reset();
            document.getElementById('userFormError').classList.add('hidden');
            document.getElementById('userModalDetails').classList.add('hidden');
            switchUserModalTab('info');
            if (username) {
                document.getElementById('userModalTitle').innerHTML = `<i class="fas fa-user-edit"></i> ویرایش کاربر: ${username}`;
                document.getElementById('userFormUsername').value = username;
                document.getElementById('userFormUsername').readOnly = true;
                document.getElementById('userFormSubmitText').textContent = 'ذخیره تغییرات';
                document.getElementById('userModalUsername').value = username;
                document.getElementById('userModalDetails').classList.remove('hidden');
                try {
                    const user = await MarzbanAPI.getUser(mainServer.serverUrl, mainServer.token, username);
                    document.getElementById('userFormTraffic').value = user.data_limit ? user.data_limit / (1024**3) : 0;
                    document.getElementById('userFormExpiry').value = user.expire ? new Date(user.expire * 1000).toISOString().split('T')[0] : '';
                    document.getElementById('userFormStatus').value = user.status;
                    document.getElementById('userFormProxies').value = JSON.stringify(user.proxies || {}, null, 2);
                    const subLink = user.subscription_url;
                    document.getElementById('subscriptionLink').value = subLink;
                    document.getElementById('qrCodeContainer').innerHTML = `<img src="https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(subLink)}" alt="QR Code">`;
                } catch (error) {
                    document.getElementById('userFormError').textContent = `خطا در دریافت اطلاعات کاربر: ${error.message}`;
                    document.getElementById('userFormError').classList.remove('hidden');
                }
            } else {
                document.getElementById('userModalTitle').innerHTML = '<i class="fas fa-user-plus"></i> کاربر جدید';
                document.getElementById('userFormUsername').readOnly = false;
                document.getElementById('userFormSubmitText').textContent = 'ایجاد کاربر';
                document.getElementById('userFormProxies').value = JSON.stringify({ "vless": {} }, null, 2);
            }
            document.getElementById('userModal').classList.remove('hidden');
        };
        const closeUserModal = () => document.getElementById('userModal').classList.add('hidden');
        const handleUserFormSubmit = async (e) => {
            e.preventDefault();
            const username = document.getElementById('userFormUsername').value;
            const originalUsername = document.getElementById('userModalUsername').value;
            const isEdit = !!originalUsername;
            const proxiesText = document.getElementById('userFormProxies').value;
            let proxies;
            try {
                proxies = JSON.parse(proxiesText);
            } catch (jsonError) {
                document.getElementById('userFormError').textContent = `خطا در فرمت JSON کانفیگ: ${jsonError.message}`;
                document.getElementById('userFormError').classList.remove('hidden');
                switchUserModalTab('config');
                return;
            }
            const userData = {
                username: username,
                proxies: proxies,
                data_limit: document.getElementById('userFormTraffic').value * (1024**3),
                status: document.getElementById('userFormStatus').value,
                expire: document.getElementById('userFormExpiry').value ? Math.floor(new Date(document.getElementById('userFormExpiry').value).getTime() / 1000) : 0,
            };
            try {
                if (isEdit) {
                    await MarzbanAPI.modifyUser(mainServer.serverUrl, mainServer.token, originalUsername, userData);
                    showNotification(`کاربر ${originalUsername} با موفقیت ویرایش شد.`, 'success');
                } else {
                    await MarzbanAPI.addUser(mainServer.serverUrl, mainServer.token, userData);
                    showNotification(`کاربر ${username} با موفقیت ایجاد شد.`, 'success');
                }
                closeUserModal();
                loadUsers(1);
            } catch (error) {
                document.getElementById('userFormError').textContent = `خطا: ${error.message}`;
                document.getElementById('userFormError').classList.remove('hidden');
            }
        };
        const switchUserModalTab = (tabName) => {
            document.querySelectorAll('.modal-tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.modal-tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(`userModalTab${tabName.charAt(0).toUpperCase() + tabName.slice(1)}`).classList.add('active');
            document.getElementById(`userModalContent${tabName.charAt(0).toUpperCase() + tabName.slice(1)}`).classList.add('active');
        };
        const deleteUser = async (username) => {
            if (confirm(`آیا از حذف کاربر ${username} مطمئن هستید؟`)) {
                try {
                    await MarzbanAPI.deleteUser(mainServer.serverUrl, mainServer.token, username);
                    showNotification(`کاربر ${username} حذف شد.`, 'success');
                    loadUsers(1);
                } catch (error) {
                    showNotification(`خطا در حذف کاربر: ${error.message}`, 'error');
                }
            }
        };
        const resetUserTraffic = async (username) => {
             if (confirm(`آیا از ریست کردن ترافیک کاربر ${username} مطمئن هستید؟`)) {
                try {
                    await MarzbanAPI.resetUserTraffic(mainServer.serverUrl, mainServer.token, username);
                    showNotification(`ترافیک کاربر ${username} ریست شد.`, 'success');
                    loadUsers(1);
                } catch (error) {
                    showNotification(`خطا در ریست ترافیک: ${error.message}`, 'error');
                }
            }
        };
        const copySubscriptionLink = () => {
            const input = document.getElementById('subscriptionLink');
            input.select();
            document.execCommand('copy');
            showNotification('لینک اشتراک کپی شد!', 'success');
        };
        const refreshUsersSection = () => loadUsers(1);

        // --- SYSTEM STATUS ---
        const loadSystemStatus = async () => {
             if (!mainServer || !mainServer.token) return;
             try {
                const data = await MarzbanAPI.getSystemInfo(mainServer.serverUrl, mainServer.token);
                if (data && data.stats) {
                    const stats = data.stats;
                    // CPU
                    document.getElementById('cpuUsage').textContent = `${stats.cpu_usage.toFixed(1)}%`;
                    document.getElementById('cpuProgress').style.width = `${stats.cpu_usage}%`;
                    // RAM
                    const memPercent = stats.mem_total > 0 ? ((stats.mem_total - stats.mem_free) / stats.mem_total * 100) : 0;
                    document.getElementById('ramUsage').textContent = `${memPercent.toFixed(1)}%`;
                    document.getElementById('ramProgress').style.width = `${memPercent}%`;
                    document.getElementById('ramDetails').textContent = `${formatBytes(stats.mem_total - stats.mem_free)} / ${formatBytes(stats.mem_total)}`;
                    // Disk
                    const diskPercent = stats.disk_total > 0 ? (stats.disk_used / stats.disk_total * 100) : 0;
                    document.getElementById('diskUsage').textContent = `${diskPercent.toFixed(1)}%`;
                    document.getElementById('diskProgress').style.width = `${diskPercent}%`;
                    document.getElementById('diskDetails').textContent = `${formatBytes(stats.disk_used)} / ${formatBytes(stats.disk_total)}`;
                    // Network
                    const totalBandwidth = (stats.net_speed.down + stats.net_speed.up);
                    document.getElementById('bandwidthUsage').textContent = formatBytes(totalBandwidth) + '/s';
                    document.getElementById('downloadSpeed').textContent = formatBytes(stats.net_speed.down) + '/s';
                    document.getElementById('uploadSpeed').textContent = formatBytes(stats.net_speed.up) + '/s';
                } else {
                    showNotification('پاسخ وضعیت سیستم معتبر نبود.', 'warning');
                }
             } catch(error) {
                 showNotification(`خطا در دریافت وضعیت سیستم: ${error.message}`, 'error');
             }
        };
        const refreshSystemSection = () => loadSystemStatus();

        // --- ANALYTICS SECTION ---
        const loadAnalyticsData = async () => {
            const content = document.getElementById('analyticsContent');
            const btn = document.getElementById('refreshAnalyticsBtn');
            setLoadingState(btn, true);
            if (!mainServer || !mainServer.token) {
                content.innerHTML = '<div class="section-loading">پیکربندی سرور اصلی یافت نشد.</div>';
                setLoadingState(btn, false);
                return;
            }
            content.innerHTML = '<div class="section-loading"><div class="loading-spinner"></div></div>';
            try {
                const data = await MarzbanAPI.getUsers(mainServer.serverUrl, mainServer.token, { limit: 0 });
                const users = data.users;
                const statusCounts = users.reduce((acc, user) => { acc[user.status] = (acc[user.status] || 0) + 1; return acc; }, { active: 0, disabled: 0, expired: 0, limited: 0 });
                const topUsers = users.sort((a, b) => b.used_traffic - a.used_traffic).slice(0, 5);
                content.innerHTML = `
                    <div class="stats-grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));">
                        <div class="stats-card"><div class="stats-icon" style="background: var(--success-color);"><i class="fas fa-user-check"></i></div><div class="stats-number">${statusCounts.active}</div><div class="stats-label">فعال</div></div>
                        <div class="stats-card"><div class="stats-icon" style="background: var(--danger-color);"><i class="fas fa-user-times"></i></div><div class="stats-number">${statusCounts.expired}</div><div class="stats-label">منقضی</div></div>
                        <div class="stats-card"><div class="stats-icon" style="background: var(--text-muted);"><i class="fas fa-user-slash"></i></div><div class="stats-number">${statusCounts.disabled}</div><div class="stats-label">غیرفعال</div></div>
                        <div class="stats-card"><div class="stats-icon" style="background: var(--warning-color);"><i class="fas fa-user-lock"></i></div><div class="stats-number">${statusCounts.limited}</div><div class="stats-label">محدود</div></div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 24px; margin-top: 24px;" class="stats-grid">
                        <div class="chart-container">
                            <h4 class="chart-title">پراکندگی وضعیت</h4>
                            <div style="position: relative; height: 300px;">
                                <canvas id="userStatusChart"></canvas>
                            </div>
                        </div>
                        <div class="chart-container">
                            <h4 class="chart-title">۵ کاربر پرمصرف</h4>
                            <div style="position: relative; height: 300px;">
                                <canvas id="topUsersChart"></canvas>
                            </div>
                        </div>
                    </div>
                `;
                renderUserStatusChart(statusCounts);
                renderTopUsersChart(topUsers);
                setTheme(localStorage.getItem(CONFIG_KEYS.theme) || 'light');
            } catch (error) {
                content.innerHTML = `<div class="section-loading">خطا: ${error.message}</div>`;
            } finally {
                setLoadingState(btn, false);
            }
        };
        const renderUserStatusChart = (statusCounts) => {
            destroyChart('userStatusChart');
            const ctx = document.getElementById('userStatusChart').getContext('2d');
            chartInstances.userStatusChart = new Chart(ctx, { type: 'doughnut', data: { labels: ['فعال', 'منقضی', 'غیرفعال', 'محدود'], datasets: [{ data: [statusCounts.active, statusCounts.expired, statusCounts.disabled, statusCounts.limited], backgroundColor: ['#10B981', '#EF4444', '#6B7280', '#F59E0B'], borderColor: 'var(--card-bg)', borderWidth: 4 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { color: '#64748B' } } } } });
        };
        const renderTopUsersChart = (topUsers) => {
            destroyChart('topUsersChart');
            const ctx = document.getElementById('topUsersChart').getContext('2d');
            chartInstances.topUsersChart = new Chart(ctx, { type: 'bar', data: { labels: topUsers.map(u => u.username), datasets: [{ label: 'ترافیک (GB)', data: topUsers.map(u => (u.used_traffic / (1024 ** 3)).toFixed(2)), backgroundColor: 'rgba(59, 130, 246, 0.7)', borderColor: '#3b82f6', borderWidth: 2, borderRadius: 6 }] }, options: { responsive: true, maintainAspectRatio: false, indexAxis: 'y', scales: { x: { beginAtZero: true } }, plugins: { legend: { display: false } } } });
        };

        // --- OVERALL SYSTEM CHART ---
        const renderOverallSystemChart = (data) => {
            destroyChart('overallSystemChart');
            const ctx = document.getElementById('overallSystemChart').getContext('2d');
            
            const chartData = {
                labels: ['کل کاربران', 'حجم مصرفی (GB)', 'تعداد نمایندگان', 'تعداد ادمین‌ها'],
                datasets: [{
                    label: 'آمار سیستم',
                    data: [
                        data.totalUsers,
                        Math.round(data.totalTraffic / (1024 ** 3)), // Convert to GB
                        data.totalReps,
                        data.totalAdmins
                    ],
                    backgroundColor: [
                        'rgba(16, 185, 129, 0.8)', // Green for users
                        'rgba(245, 158, 11, 0.8)', // Orange for traffic
                        'rgba(59, 130, 246, 0.8)', // Blue for reps
                        'rgba(239, 68, 68, 0.8)'   // Red for admins
                    ],
                    borderColor: [
                        '#10B981',
                        '#F59E0B', 
                        '#3B82F6',
                        '#EF4444'
                    ],
                    borderWidth: 2,
                    borderRadius: 8,
                    borderSkipped: false,
                }]
            };

            chartInstances.overallSystemChart = new Chart(ctx, {
                type: 'bar',
                data: chartData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.chart.data.labels[context.dataIndex] || '';
                                    const value = context.parsed.y;
                                    if (label.includes('(GB)')) {
                                        return `${value} گیگابایت`;
                                    }
                                    return `${label}: ${value}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: { beginAtZero: true },
                        x: { grid: { display: false } }
                    }
                }
            });
        };

        // --- ADMINS MANAGEMENT SECTION ---
        const loadAdmins = () => {
            const container = document.getElementById('adminsTableContainer');
            const admins = getAdminCredentials();
            const usernames = Object.keys(admins);
            container.innerHTML = `<table class="data-table"><thead><tr><th>نام کاربری ادمین</th><th>عملیات</th></tr></thead><tbody>${usernames.map(username => `<tr><td><strong>${username}</strong></td><td><button class="form-button danger" onclick="deleteAdmin('${username}')" title="حذف ادمین"><i class="fas fa-trash"></i></button></td></tr>`).join('')}</tbody></table>`;
        };
        const showAdminModal = () => { document.getElementById('adminForm').reset(); document.getElementById('adminFormError').classList.add('hidden'); document.getElementById('adminModal').classList.remove('hidden'); };
        const closeAdminModal = () => document.getElementById('adminModal').classList.add('hidden');
        const handleAdminFormSubmit = (e) => {
            e.preventDefault();
            const username = document.getElementById('adminFormUsername').value.trim();
            const password = document.getElementById('adminFormPassword').value;
            if (!username || !password) { showNotification('نام کاربری و رمز عبور الزامی است.', 'error'); return; }
            const admins = getAdminCredentials();
            if (admins[username]) { document.getElementById('adminFormError').textContent = 'این نام کاربری قبلا استفاده شده است.'; document.getElementById('adminFormError').classList.remove('hidden'); return; }
            admins[username] = password;
            saveAdminCredentials(admins);
            showNotification(`ادمین ${username} با موفقیت اضافه شد.`, 'success');
            closeAdminModal();
            loadAdmins();
        };
        const deleteAdmin = (username) => {
            const loggedInUser = sessionStorage.getItem(CONFIG_KEYS.adminUsername);
            if (username === loggedInUser) { showNotification('شما نمی‌توانید حساب کاربری خودتان را حذف کنید.', 'error'); return; }
            if (confirm(`آیا از حذف ادمین ${username} مطمئن هستید؟`)) {
                const admins = getAdminCredentials();
                delete admins[username];
                saveAdminCredentials(admins);
                showNotification(`ادمین ${username} حذف شد.`, 'success');
                loadAdmins();
            }
        };

        // --- SETTINGS SECTION ---
        const loadSettings = () => {
            const storedServer = localStorage.getItem(CONFIG_KEYS.mainServer);
            if (storedServer) {
                const server = JSON.parse(storedServer);
                document.getElementById('mainServerUrl').value = server.serverUrl || '';
                document.getElementById('mainServerUsername').value = server.username || '';
                document.getElementById('mainServerPassword').value = server.password || '';
            }
            document.getElementById('currentAdminUsername').value = sessionStorage.getItem(CONFIG_KEYS.adminUsername);
        };
        const handleMainServerFormSubmit = async (e) => {
            e.preventDefault();
            const btn = document.getElementById('saveMainServerBtn');
            setLoadingState(btn, true);
            const serverConfig = { serverUrl: document.getElementById('mainServerUrl').value.trim().replace(/\/$/, ''), username: document.getElementById('mainServerUsername').value.trim(), password: document.getElementById('mainServerPassword').value };
            try {
                updateConnectionStatus('connecting');
                const { access_token } = await MarzbanAPI.login(serverConfig.serverUrl, serverConfig.username, serverConfig.password);
                serverConfig.token = access_token;
                localStorage.setItem(CONFIG_KEYS.mainServer, JSON.stringify(serverConfig));
                mainServer = serverConfig;
                updateConnectionStatus('connected');
                showNotification('تنظیمات سرور اصلی با موفقیت ذخیره و اتصال برقرار شد.', 'success');
            } catch (error) {
                updateConnectionStatus('disconnected');
                showNotification(`خطا در ورود به سرور: ${error.message}`, 'error');
            } finally {
                setLoadingState(btn, false);
            }
        };
        const testMainServerConnection = async () => {
            const btn = document.getElementById('testMainServerBtn');
            setLoadingState(btn, true);
            const serverUrl = document.getElementById('mainServerUrl').value.trim().replace(/\/$/, '');
            const username = document.getElementById('mainServerUsername').value.trim();
            const password = document.getElementById('mainServerPassword').value;
            if (!serverUrl || !username || !password) { showNotification('لطفا تمام فیلدهای سرور اصلی را پر کنید.', 'warning'); setLoadingState(btn, false); return; }
            try {
                updateConnectionStatus('connecting');
                await MarzbanAPI.login(serverUrl, username, password);
                updateConnectionStatus('connected');
                showNotification('اتصال به سرور با موفقیت برقرار شد.', 'success');
            } catch (error) {
                updateConnectionStatus('disconnected');
                showNotification(`خطا در اتصال: ${error.message}`, 'error');
            } finally {
                setLoadingState(btn, false);
            }
        };
        const handleChangePasswordFormSubmit = (e) => {
            e.preventDefault();
            const username = document.getElementById('currentAdminUsername').value;
            const newPassword = document.getElementById('newAdminPassword').value;
            if (newPassword.length < 6) { showNotification('رمز عبور باید حداقل ۶ کاراکتر باشد.', 'error'); return; }
            const admins = getAdminCredentials();
            admins[username] = newPassword;
            saveAdminCredentials(admins);
            document.getElementById('newAdminPassword').value = '';
            showNotification('رمز عبور شما با موفقیت تغییر کرد.', 'success');
        };

        // --- REPRESENTATIVES MONITOR SECTION ---
        const getMonitoredReps = () => JSON.parse(localStorage.getItem(CONFIG_KEYS.monitoredReps)) || [];
        const saveMonitoredReps = (reps) => localStorage.setItem(CONFIG_KEYS.monitoredReps, JSON.stringify(reps));
        const handleAddMonitorFormSubmit = async (e) => {
            e.preventDefault();
            const btn = document.getElementById('addMonitorBtn');
            setLoadingState(btn, true);
            document.getElementById('addMonitorError').classList.add('hidden');
            const newRep = { id: `rep_${Date.now()}`, displayName: document.getElementById('monitorDisplayName').value.trim(), serverUrl: document.getElementById('monitorServerUrl').value.trim().replace(/\/$/, ''), username: document.getElementById('monitorUsername').value.trim(), password: document.getElementById('monitorPassword').value };
            try {
                const { access_token } = await MarzbanAPI.login(newRep.serverUrl, newRep.username, newRep.password);
                newRep.token = access_token;
                const reps = getMonitoredReps();
                reps.push(newRep);
                saveMonitoredReps(reps);
                showNotification(`نماینده "${newRep.displayName}" با موفقیت اضافه شد.`, 'success');
                document.getElementById('addMonitorForm').reset();
                refreshMonitorSection();
            } catch (error) {
                const errorEl = document.getElementById('addMonitorError');
                errorEl.textContent = `خطا در افزودن نماینده: ${error.message}`;
                errorEl.classList.remove('hidden');
            } finally {
                setLoadingState(btn, false);
            }
        };
        const refreshMonitorSection = async () => {
            const btn = document.getElementById('refreshMonitorBtn');
            setLoadingState(btn, true);
            const reps = getMonitoredReps();
            const container = document.getElementById('representativesContent');
            if (reps.length === 0) {
                container.innerHTML = '<div class="section-loading">هیچ نماینده‌ای برای مانیتورینگ اضافه نشده است.</div>';
                setLoadingState(btn, false);
                return;
            }
            container.innerHTML = '<div class="section-loading"><div class="loading-spinner"></div><span>در حال دریافت اطلاعات...</span></div>';
            const promises = reps.map(rep => Promise.all([MarzbanAPI.getUsers(rep.serverUrl, rep.token, { limit: 0 }).catch(e => ({ error: e.message, total: 'N/A', users: [] })), MarzbanAPI.getSystemInfo(rep.serverUrl, rep.token).catch(e => ({ error: e.message, stats: null }))]).then(([usersData, systemData]) => ({ ...rep, usersData, systemData })));
            monitoredRepsCache = await Promise.all(promises);
            handleRepSearch(); // Use search handler to render
            setLoadingState(btn, false);
        };
        const handleRepSearch = () => {
            const searchTerm = document.getElementById('repSearch').value.toLowerCase();
            const filteredReps = monitoredRepsCache.filter(rep => rep.displayName.toLowerCase().includes(searchTerm));
            renderMonitoredReps(filteredReps);
        };
        const renderMonitoredReps = (results) => {
            const container = document.getElementById('representativesContent');
            if (results.length === 0) {
                container.innerHTML = '<div class="section-loading">نماینده‌ای با این نام یافت نشد.</div>';
                return;
            }
            container.innerHTML = results.map(res => {
                const hasError = res.usersData.error || res.systemData.error;
                const totalUsers = res.usersData.total;
                const totalTraffic = hasError ? 0 : res.usersData.users.reduce((acc, u) => acc + u.used_traffic, 0);
                const onlineUsers = hasError ? 0 : res.usersData.users.filter(u => u.online_at && (new Date() - new Date(u.online_at) < 300000)).length;
                const cpuUsage = res.systemData.stats ? res.systemData.stats.cpu_usage.toFixed(1) : 'N/A';
                return `<div class="monitor-card ${hasError ? 'error' : ''}"><div class="monitor-header"><h4 class="monitor-username">${res.displayName}</h4><div class="monitor-status">${hasError ? `<i class="fas fa-exclamation-triangle"></i><span>خطا: ${res.usersData.error || res.systemData.error}</span>` : `<i class="fas fa-check-circle"></i><span>متصل</span>`}</div><button class="form-button danger" style="padding: 6px 10px; font-size: 12px;" onclick="deleteMonitoredRep('${res.id}')"><i class="fas fa-trash"></i></button></div><div class="monitor-stats"><div class="monitor-stat"><div class="monitor-stat-value">${totalUsers}</div><div class="monitor-stat-label">کل کاربران</div></div><div class="monitor-stat"><div class="monitor-stat-value">${onlineUsers}</div><div class="monitor-stat-label">آنلاین</div></div><div class="monitor-stat"><div class="monitor-stat-value">${formatBytes(totalTraffic)}</div><div class="monitor-stat-label">کل ترافیک</div></div><div class="monitor-stat"><div class="monitor-stat-value">${cpuUsage}%</div><div class="monitor-stat-label">مصرف CPU</div></div></div></div>`;
            }).join('');
        };
        const deleteMonitoredRep = (repId) => {
            if (confirm('آیا از حذف این نماینده از لیست مانیتورینگ مطمئن هستید؟')) {
                let reps = getMonitoredReps();
                reps = reps.filter(r => r.id !== repId);
                saveMonitoredReps(reps);
                showNotification('نماینده از لیست حذف شد.', 'success');
                refreshMonitorSection();
            }
        };

        // --- LOGS ---
        const loadRepLogs = () => {
            const container = document.getElementById('repLogsContainer');
            const logs = JSON.parse(localStorage.getItem(CONFIG_KEYS.repLoginLogs)) || [];
            if (logs.length === 0) {
                container.innerHTML = '<div class="section-loading">هیچ لاگ ورودی ثبت نشده است.</div>';
                return;
            }
            const table = `<table class="data-table"><thead><tr><th>نام نماینده</th><th>تاریخ و زمان ورود</th></tr></thead><tbody>
                ${logs.reverse().map(log => `<tr><td><strong>${log.repName}</strong></td><td>${new Date(log.timestamp).toLocaleString('fa-IR')}</td></tr>`).join('')}
            </tbody></table>`;
            container.innerHTML = table;
        };

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            initTheme();
            checkSession();
            // Event Listeners
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            document.getElementById('userForm').addEventListener('submit', handleUserFormSubmit);
            document.getElementById('adminForm').addEventListener('submit', handleAdminFormSubmit);
            document.getElementById('mainServerForm').addEventListener('submit', handleMainServerFormSubmit);
            document.getElementById('changePasswordForm').addEventListener('submit', handleChangePasswordFormSubmit);
            document.getElementById('addMonitorForm').addEventListener('submit', handleAddMonitorFormSubmit);
        });
    </script>
</body>
</html>
